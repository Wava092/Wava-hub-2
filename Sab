--[[
    WAVA HUB REMASTERED
    UI Re-design with Animations & Modern Layout
    All Logic Preserved
]]

if not game:IsLoaded() then
    game.Loaded:Wait()
end

-- // SERVICES //
local CoreGui = game:GetService("CoreGui")
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer

-- // CONFIG SYSTEM //
local CONFIG_FILE = "dyhub_sab_config.json"
local function canWriteFiles()
    return type(writefile) == "function" and type(readfile) == "function" and type(isfile) == "function"
end

local config = {
    SpeedBoost = false,
    BoostSpeedValue = 50,
    AntiTrap = false,
    InfiniteJump = false,
    ESP = false,
    ViewBaseTimers = false,
    Autobuy = {},
    SelectedJobId = nil,
    Theme = "Purple" -- Default theme
}

local function loadConfig()
    if canWriteFiles() and isfile(CONFIG_FILE) then
        local ok, txt = pcall(readfile, CONFIG_FILE)
        if ok and txt then
            local decodeOk, data = pcall(function() return HttpService:JSONDecode(txt) end)
            if decodeOk and type(data) == "table" then
                for k,v in pairs(data) do config[k] = v end
            end
        end
    end
end

local function saveConfig()
    if canWriteFiles() then
        pcall(function()
            writefile(CONFIG_FILE, HttpService:JSONEncode(config))
        end)
    end
end

loadConfig()

-- // UTILS //
local function tryLoadURLToRun(url)
    local ok, err = pcall(function()
        local txt = game:HttpGet(url)
        local f = loadstring(txt)
        if f then pcall(f) end
    end)
    if not ok then warn("Failed to load:", url, err) end
end

-- // LOGIC VARIABLES (Preserved from original) //
local antiTrapEnabled = false
local antiTrapConn = nil
local plotTimers_Enabled = false
local plotTimers_RenderConnection = nil
local plotTimers_OriginalProperties = {}
local speedBoostEnabled = false
local speedConn = nil
local infiniteJumpEnabled = false
local floatEnabled = false
local floatConn = nil
local baseY = nil
local jumpBoostEnabled = false
local jumpConn = nil
local godModeEnabled = false
local antiRagdollEnabled = false
local antiConnections = {}
local characterAddedConn = nil
local autoSlapEnabled = false
local playersEspEnabled = false
local playerEspMap = {}
local lockEspEnabled = false
local lockEspMap = {}
local rarityEnabled = { Mythic = false, ["Brainrot God"] = false, Secret = false }
local espObjects = {} -- For highlight ESP
local espConns = {}
local espActive = false
local afkHideActive = false
local hideBrainrotActive = false
local floatUpActive = false
local floatUpConn = nil
local floatFallActive = false
local floatFallConn = nil
local lockReminderActive = false
local antiDieActive = false
-- Rig Swap variables
local originalHRP, realHRP, originalHipHeight, animTrack, preSimConn
local slapToolNames = { "Tung Bat", "Blackhole Slap", "Dark Matter Slap", "Dev Slap", "Devil Slap", "Diamond Slap", "Emerald Slap", "Flame Slap", "Gold Slap", "Iron Slap", "Nuclear Slap", "Ruby Slap", "Slap" }

-- // UI LIBRARY (Modern Animated UI) //
local UI = {}
local UI_Elements = {} -- Store elements for theming

local ThemeColors = {
    Purple = { Main = Color3.fromRGB(25, 25, 35), Accent = Color3.fromRGB(138, 43, 226), Text = Color3.fromRGB(255, 255, 255) },
    Pink = { Main = Color3.fromRGB(30, 20, 25), Accent = Color3.fromRGB(255, 105, 180), Text = Color3.fromRGB(255, 220, 240) },
    Red = { Main = Color3.fromRGB(30, 20, 20), Accent = Color3.fromRGB(220, 50, 50), Text = Color3.fromRGB(255, 200, 200) },
    Green = { Main = Color3.fromRGB(20, 30, 20), Accent = Color3.fromRGB(50, 200, 100), Text = Color3.fromRGB(200, 255, 200) },
    Black = { Main = Color3.fromRGB(15, 15, 15), Accent = Color3.fromRGB(80, 80, 80), Text = Color3.fromRGB(255, 255, 255) },
    White = { Main = Color3.fromRGB(240, 240, 240), Accent = Color3.fromRGB(50, 50, 50), Text = Color3.fromRGB(20, 20, 20) },
}

local CurrentTheme = ThemeColors[config.Theme] or ThemeColors.Purple

function UI:UpdateTheme(themeName)
    config.Theme = themeName
    saveConfig()
    CurrentTheme = ThemeColors[themeName]
    
    -- Animate changes
    local info = TweenInfo.new(0.5)
    for _, el in pairs(UI_Elements) do
        if el.Type == "MainFrame" then TweenService:Create(el.Obj, info, {BackgroundColor3 = CurrentTheme.Main}):Play()
        elseif el.Type == "Sidebar" then TweenService:Create(el.Obj, info, {BackgroundColor3 = CurrentTheme.Main}):Play() -- Slightly lighter/darker handling later
        elseif el.Type == "Accent" then TweenService:Create(el.Obj, info, {BackgroundColor3 = CurrentTheme.Accent}):Play()
        elseif el.Type == "Text" then TweenService:Create(el.Obj, info, {TextColor3 = CurrentTheme.Text}):Play()
        elseif el.Type == "ToggleOn" and el.State then TweenService:Create(el.Obj, info, {BackgroundColor3 = CurrentTheme.Accent}):Play()
        end
    end
end

function UI:CreateWindow(titleText)
    -- Cleanup Old
    if CoreGui:FindFirstChild("WavaRemastered") then CoreGui.WavaRemastered:Destroy() end

    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "WavaRemastered"
    ScreenGui.Parent = CoreGui
    ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

    local MainFrame = Instance.new("Frame")
    MainFrame.Name = "MainFrame"
    MainFrame.Size = UDim2.new(0, 550, 0, 350)
    MainFrame.Position = UDim2.new(0.5, -275, 0.5, -175)
    MainFrame.BackgroundColor3 = CurrentTheme.Main
    MainFrame.BorderSizePixel = 0
    MainFrame.ClipsDescendants = true
    MainFrame.Parent = ScreenGui
    table.insert(UI_Elements, {Type = "MainFrame", Obj = MainFrame})

    local MainCorner = Instance.new("UICorner", MainFrame)
    MainCorner.CornerRadius = UDim.new(0, 10)
    
    local Drag = Instance.new("UIDragDetector", MainFrame) -- Modern dragging

    -- Header
    local Header = Instance.new("Frame")
    Header.Size = UDim2.new(1, 0, 0, 40)
    Header.BackgroundTransparency = 1
    Header.Parent = MainFrame

    local Title = Instance.new("TextLabel")
    Title.Text = titleText
    Title.Font = Enum.Font.GothamBold
    Title.TextSize = 18
    Title.TextColor3 = CurrentTheme.Text
    Title.Size = UDim2.new(1, -50, 1, 0)
    Title.Position = UDim2.new(0, 20, 0, 0)
    Title.BackgroundTransparency = 1
    Title.TextXAlignment = Enum.TextXAlignment.Left
    Title.Parent = Header
    table.insert(UI_Elements, {Type = "Text", Obj = Title})

    local CloseBtn = Instance.new("TextButton")
    CloseBtn.Size = UDim2.new(0, 40, 0, 40)
    CloseBtn.Position = UDim2.new(1, -40, 0, 0)
    CloseBtn.BackgroundTransparency = 1
    CloseBtn.Text = "Ã—"
    CloseBtn.TextSize = 24
    CloseBtn.TextColor3 = Color3.fromRGB(200, 200, 200)
    CloseBtn.Parent = Header
    CloseBtn.MouseButton1Click:Connect(function() ScreenGui:Destroy() end)

    -- Sidebar
    local Sidebar = Instance.new("ScrollingFrame")
    Sidebar.Size = UDim2.new(0, 130, 1, -50)
    Sidebar.Position = UDim2.new(0, 10, 0, 45)
    Sidebar.BackgroundTransparency = 1
    Sidebar.ScrollBarThickness = 2
    Sidebar.Parent = MainFrame

    local SidebarLayout = Instance.new("UIListLayout", Sidebar)
    SidebarLayout.Padding = UDim.new(0, 5)

    -- Content Area
    local ContentArea = Instance.new("Frame")
    ContentArea.Size = UDim2.new(1, -155, 1, -50)
    ContentArea.Position = UDim2.new(0, 150, 0, 45)
    ContentArea.BackgroundTransparency = 1
    ContentArea.Parent = MainFrame

    local Window = {
        ScreenGui = ScreenGui,
        MainFrame = MainFrame,
        Sidebar = Sidebar,
        ContentArea = ContentArea,
        Tabs = {},
        ActiveTab = nil
    }

    -- Intro Animation
    MainFrame.Size = UDim2.new(0, 550, 0, 0)
    TweenService:Create(MainFrame, TweenInfo.new(0.6, Enum.EasingStyle.Exponential), {Size = UDim2.new(0, 550, 0, 350)}):Play()

    function Window:Tab(name)
        local TabBtn = Instance.new("TextButton")
        TabBtn.Size = UDim2.new(1, -5, 0, 32)
        TabBtn.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
        TabBtn.BackgroundTransparency = 1
        TabBtn.Text = name
        TabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
        TabBtn.Font = Enum.Font.GothamMedium
        TabBtn.TextSize = 13
        TabBtn.Parent = Sidebar
        
        local TabCorner = Instance.new("UICorner", TabBtn)
        TabCorner.CornerRadius = UDim.new(0, 6)

        local TabFrame = Instance.new("ScrollingFrame")
        TabFrame.Size = UDim2.new(1, 0, 1, 0)
        TabFrame.BackgroundTransparency = 1
        TabFrame.Visible = false
        TabFrame.ScrollBarThickness = 2
        TabFrame.Parent = ContentArea
        
        local TabLayout = Instance.new("UIListLayout", TabFrame)
        TabLayout.Padding = UDim.new(0, 6)
        TabLayout.SortOrder = Enum.SortOrder.LayoutOrder

        local TabObj = {Frame = TabFrame, Btn = TabBtn}

        TabBtn.MouseButton1Click:Connect(function()
            for _, t in pairs(Window.Tabs) do
                t.Frame.Visible = false
                TweenService:Create(t.Btn, TweenInfo.new(0.3), {BackgroundTransparency = 1, TextColor3 = Color3.fromRGB(150, 150, 150)}):Play()
            end
            TabFrame.Visible = true
            TweenService:Create(TabBtn, TweenInfo.new(0.3), {BackgroundTransparency = 0.8, TextColor3 = CurrentTheme.Accent}):Play()
            table.insert(UI_Elements, {Type = "Text", Obj = TabBtn}) -- Update theme ref for active text
        end)

        if #Window.Tabs == 0 then
            TabBtn.TextColor3 = CurrentTheme.Accent
            TabBtn.BackgroundTransparency = 0.8
            TabFrame.Visible = true
        end

        table.insert(Window.Tabs, TabObj)

        local Items = {}

        function Items:Button(text, callback)
            local Btn = Instance.new("TextButton")
            Btn.Size = UDim2.new(1, -5, 0, 35)
            Btn.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
            Btn.Text = text
            Btn.TextColor3 = Color3.fromRGB(255, 255, 255)
            Btn.Font = Enum.Font.Gotham
            Btn.TextSize = 12
            Btn.Parent = TabFrame
            
            local BtnCorner = Instance.new("UICorner", Btn)
            BtnCorner.CornerRadius = UDim.new(0, 6)

            Btn.MouseEnter:Connect(function() TweenService:Create(Btn, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(50, 50, 50)}):Play() end)
            Btn.MouseLeave:Connect(function() TweenService:Create(Btn, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(40, 40, 40)}):Play() end)
            
            Btn.MouseButton1Click:Connect(function()
                local ripple = Instance.new("Frame", Btn)
                ripple.BackgroundColor3 = Color3.new(1,1,1)
                ripple.BackgroundTransparency = 0.8
                ripple.Size = UDim2.new(0,0,0,0)
                ripple.Position = UDim2.new(0.5,0,0.5,0)
                ripple.AnchorPoint = Vector2.new(0.5,0.5)
                local c = Instance.new("UICorner", ripple); c.CornerRadius = UDim.new(1,0)
                TweenService:Create(ripple, TweenInfo.new(0.4), {Size = UDim2.new(1.2,0,1.5,0), BackgroundTransparency = 1}):Play()
                game.Debris:AddItem(ripple, 0.45)
                callback()
            end)
        end

        function Items:Toggle(text, default, callback)
            local ToggleFrame = Instance.new("TextButton")
            ToggleFrame.Size = UDim2.new(1, -5, 0, 35)
            ToggleFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
            ToggleFrame.Text = ""
            ToggleFrame.AutoButtonColor = false
            ToggleFrame.Parent = TabFrame
            
            local TCorner = Instance.new("UICorner", ToggleFrame)
            TCorner.CornerRadius = UDim.new(0, 6)

            local Label = Instance.new("TextLabel")
            Label.Size = UDim2.new(0.7, 0, 1, 0)
            Label.Position = UDim2.new(0, 10, 0, 0)
            Label.BackgroundTransparency = 1
            Label.Text = text
            Label.Font = Enum.Font.Gotham
            Label.TextColor3 = Color3.fromRGB(255, 255, 255)
            Label.TextXAlignment = Enum.TextXAlignment.Left
            Label.TextSize = 12
            Label.Parent = ToggleFrame

            local Indicator = Instance.new("Frame")
            Indicator.Size = UDim2.new(0, 40, 0, 20)
            Indicator.Position = UDim2.new(1, -50, 0.5, -10)
            Indicator.BackgroundColor3 = default and CurrentTheme.Accent or Color3.fromRGB(60, 60, 60)
            Indicator.Parent = ToggleFrame
            local ICorner = Instance.new("UICorner", Indicator); ICorner.CornerRadius = UDim.new(1, 0)

            local Circle = Instance.new("Frame")
            Circle.Size = UDim2.new(0, 16, 0, 16)
            Circle.Position = default and UDim2.new(1, -18, 0.5, -8) or UDim2.new(0, 2, 0.5, -8)
            Circle.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
            Circle.Parent = Indicator
            local CCorner = Instance.new("UICorner", Circle); CCorner.CornerRadius = UDim.new(1, 0)

            local state = default
            local elRef = {Type = "ToggleOn", Obj = Indicator, State = state}
            table.insert(UI_Elements, elRef)

            ToggleFrame.MouseButton1Click:Connect(function()
                state = not state
                elRef.State = state
                callback(state)
                
                if state then
                    TweenService:Create(Indicator, TweenInfo.new(0.2), {BackgroundColor3 = CurrentTheme.Accent}):Play()
                    TweenService:Create(Circle, TweenInfo.new(0.2, Enum.EasingStyle.Back), {Position = UDim2.new(1, -18, 0.5, -8)}):Play()
                else
                    TweenService:Create(Indicator, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(60, 60, 60)}):Play()
                    TweenService:Create(Circle, TweenInfo.new(0.2, Enum.EasingStyle.Back), {Position = UDim2.new(0, 2, 0.5, -8)}):Play()
                end
            end)
        end
        
        function Items:Input(placeholder, defaultText, callback)
            local Container = Instance.new("Frame")
            Container.Size = UDim2.new(1, -5, 0, 35)
            Container.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
            Container.Parent = TabFrame
            Instance.new("UICorner", Container).CornerRadius = UDim.new(0, 6)
            
            local Box = Instance.new("TextBox")
            Box.Size = UDim2.new(1, -20, 1, 0)
            Box.Position = UDim2.new(0, 10, 0, 0)
            Box.BackgroundTransparency = 1
            Box.Text = defaultText
            Box.PlaceholderText = placeholder
            Box.TextColor3 = Color3.fromRGB(255, 255, 255)
            Box.Font = Enum.Font.Gotham
            Box.TextSize = 12
            Box.TextXAlignment = Enum.TextXAlignment.Left
            Box.Parent = Container
            
            Box.FocusLost:Connect(function()
                callback(Box.Text)
            end)
            
            local btn = Instance.new("TextButton")
            btn.Size = UDim2.new(0, 40, 1, 0)
            btn.Position = UDim2.new(1, -40, 0, 0)
            btn.BackgroundTransparency = 1
            btn.Text = "Set"
            btn.TextColor3 = CurrentTheme.Accent
            btn.Font = Enum.Font.GothamBold
            btn.Parent = Container
            table.insert(UI_Elements, {Type = "Text", Obj = btn})
            
            btn.MouseButton1Click:Connect(function() callback(Box.Text) end)
        end
        
        function Items:Label(text)
            local Lbl = Instance.new("TextLabel")
            Lbl.Size = UDim2.new(1, -5, 0, 20)
            Lbl.BackgroundTransparency = 1
            Lbl.Text = text
            Lbl.TextColor3 = Color3.fromRGB(150, 150, 150)
            Lbl.Font = Enum.Font.GothamBold
            Lbl.TextSize = 11
            Lbl.Parent = TabFrame
        end

        return Items
    end
    return Window
end

-- // FUNCTION IMPLEMENTATIONS (Preserved Logic) //

local function enableAntiTrap()
    if antiTrapEnabled then return end
    antiTrapEnabled = true
    local BATCH_SIZE = 250
    local SEARCH_TRAPS_IN_GAME = false

    local function shouldRemoveTrapTouch(tt)
        if not (tt:IsA("TouchTransmitter") and tt.Name == "TouchInterest") then return false end
        local p = tt.Parent
        if not (p and p:IsA("MeshPart") and p.Name == "Open") then return false end
        local m = p:FindFirstAncestorOfClass("Model")
        if not (m and m.Name == "Trap") then return false end
        return true
    end

    local function removeTrapTouch(tt)
        pcall(function() if tt.Parent then tt:Destroy() end end)
    end

    task.defer(function()
        local root = SEARCH_TRAPS_IN_GAME and game or workspace
        local all = root:GetDescendants()
        for i = 1, #all do
            local o = all[i]
            if o:IsA("TouchTransmitter") and shouldRemoveTrapTouch(o) then
                removeTrapTouch(o)
            end
            if i % BATCH_SIZE == 0 then task.wait() end
        end
    end)

    antiTrapConn = workspace.DescendantAdded:Connect(function(obj)
        if obj:IsA("TouchTransmitter") and shouldRemoveTrapTouch(obj) then
            removeTrapTouch(obj)
        end
    end)
end

local function disableAntiTrap()
    antiTrapEnabled = false
    if antiTrapConn then
        antiTrapConn:Disconnect()
        antiTrapConn = nil
    end
end

local function enablePlotTimers()
    plotTimers_Enabled = true
    local camera = workspace.CurrentCamera
    local DISTANCE_THRESHOLD = 45
    local SCALE_START, SCALE_RANGE = 100, 300
    local MIN_TEXT_SIZE, MAX_TEXT_SIZE = 30, 36
    local lastUpdate = 0

    plotTimers_RenderConnection = RunService.RenderStepped:Connect(function()
        if not plotTimers_Enabled then return end
        if tick() - lastUpdate < 0.1 then return end
        lastUpdate = tick()

        for _, label in ipairs(workspace.Plots:GetDescendants()) do
            if label:IsA("TextLabel") and label.Name == "RemainingTime" then
                local bb = label:FindFirstAncestorWhichIsA("BillboardGui")
                if not bb then continue end
                local model = bb:FindFirstAncestorOfClass("Model")
                if not model then continue end
                local basePart = model:FindFirstChildWhichIsA("BasePart", true)
                if not basePart then continue end
                
                if not plotTimers_OriginalProperties[label] then
                    plotTimers_OriginalProperties[label] = {
                        bb_enabled = bb.Enabled, bb_alwaysOnTop = bb.AlwaysOnTop,
                        bb_size = bb.Size, bb_maxDistance = bb.MaxDistance,
                        label_textScaled = label.TextScaled, label_textWrapped = label.TextWrapped,
                        label_automaticSize = label.AutomaticSize, label_size = label.Size,
                        label_textSize = label.TextSize,
                    }
                end
                
                bb.MaxDistance = 10000
                bb.AlwaysOnTop = true
                bb.ClipsDescendants = false
                bb.Size = UDim2.new(0, 300, 0, 150)
                label.TextScaled = false
                label.TextWrapped = true
                label.ClipsDescendants = false
                label.Size = UDim2.new(1, 0, 0, 32)
                label.AutomaticSize = Enum.AutomaticSize.Y

                local distance = (camera.CFrame.Position - basePart.Position).Magnitude
                if distance > DISTANCE_THRESHOLD and basePart.Position.Y >= 0 then
                    bb.Enabled = false
                else
                    bb.Enabled = true
                    local t = math.clamp((distance - SCALE_START) / SCALE_RANGE, 0, 1)
                    local newTextSize = math.clamp(MIN_TEXT_SIZE + (MAX_TEXT_SIZE - MIN_TEXT_SIZE) * t, MIN_TEXT_SIZE, MAX_TEXT_SIZE)
                    label.TextSize = newTextSize
                    label.Size = UDim2.new(1, 0, 0, newTextSize + 6)
                end
            end
        end
    end)
end

local function disablePlotTimers()
    plotTimers_Enabled = false
    if plotTimers_RenderConnection then pcall(function() plotTimers_RenderConnection:Disconnect() end) end
    for label, props in pairs(plotTimers_OriginalProperties) do
        pcall(function()
            if label and label.Parent then
                local bb = label:FindFirstAncestorWhichIsA("BillboardGui")
                if bb then
                    bb.Enabled = props.bb_enabled; bb.AlwaysOnTop = props.bb_alwaysOnTop
                    bb.Size = props.bb_size; bb.MaxDistance = props.bb_maxDistance
                    label.TextScaled = props.label_textScaled; label.TextWrapped = props.label_textWrapped
                    label.AutomaticSize = props.label_automaticSize; label.Size = props.label_size
                    label.TextSize = props.label_textSize
                end
            end
        end)
    end
    table.clear(plotTimers_OriginalProperties)
end

local function autoBuySelectedItems()
    task.spawn(function()
        local autobuy_selected = config.Autobuy or {}
        for _, item in ipairs(autobuy_selected) do
            local args = { item }
            pcall(function()
                ReplicatedStorage:WaitForChild("Packages"):WaitForChild("Net"):WaitForChild("RF/CoinsShopService/RequestBuy"):InvokeServer(unpack(args))
            end)
            task.wait(0.3)
        end
    end)
end

-- Movement Functions
local function updateSpeedBoost(state)
    speedBoostEnabled = state
    config.SpeedBoost = state
    saveConfig()
    if state then
        if speedConn then speedConn:Disconnect() end
        speedConn = RunService.Heartbeat:Connect(function()
            if not speedBoostEnabled then return end
            local char = LocalPlayer.Character
            if char then
                local hum = char:FindFirstChildOfClass("Humanoid")
                local root = char:FindFirstChild("HumanoidRootPart")
                if hum and root and hum.MoveDirection.Magnitude > 0 then
                    local dir = hum.MoveDirection
                    root.Velocity = Vector3.new(dir.X * (config.BoostSpeedValue or 50), root.Velocity.Y, dir.Z * (config.BoostSpeedValue or 50))
                end
            end
        end)
    else
        if speedConn then speedConn:Disconnect(); speedConn = nil end
    end
end

local function updateJumpBoost(state)
    jumpBoostEnabled = state
    if state then
        local char = LocalPlayer.Character
        if char and char:FindFirstChildOfClass("Humanoid") then
            char.Humanoid.UseJumpPower = true
            char.Humanoid.JumpPower = 96
        end
        jumpConn = RunService.Stepped:Connect(function()
            local root = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
            if jumpBoostEnabled and root and root.Velocity.Y < 0 then
                root.Velocity = Vector3.new(root.Velocity.X, root.Velocity.Y * 0.9, root.Velocity.Z)
            end
        end)
    else
        if jumpConn then jumpConn:Disconnect() jumpConn = nil end
        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid") then
            LocalPlayer.Character.Humanoid.JumpPower = 50
        end
    end
end

local function updateFloat(state)
    floatEnabled = state
    if state then
        local char = LocalPlayer.Character
        local root = char and char:FindFirstChild("HumanoidRootPart")
        if root then
            baseY = root.Position.Y
            floatConn = RunService.Heartbeat:Connect(function()
                if not floatEnabled or not LocalPlayer.Character then return end
                local hum = LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
                local root = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                if hum and root then
                    hum:ChangeState(Enum.HumanoidStateType.Flying)
                    local cam = workspace.CurrentCamera
                    local forward = cam.CFrame.LookVector * Vector3.new(1,0,1)
                    if forward.Magnitude > 0 then forward = forward.Unit end
                    root.AssemblyLinearVelocity = forward * 40
                    root.CFrame = CFrame.new(root.Position.X, baseY + 2.7, root.Position.Z, 1,0,0,0,1,0,0,0,1) -- Simple lock
                end
            end)
        end
    else
        if floatConn then floatConn:Disconnect(); floatConn = nil end
        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid") then
            LocalPlayer.Character.Humanoid:ChangeState(Enum.HumanoidStateType.GettingUp)
        end
    end
end

-- ESP Functions
local function createPlayerEsp(plr)
    if not playersEspEnabled or plr == LocalPlayer then return end
    local char = plr.Character
    if not char then return end
    local root = char:WaitForChild("HumanoidRootPart", 5)
    if not root then return end
    
    if playerEspMap[plr] then playerEspMap[plr]:Destroy() end

    local bb = Instance.new("BillboardGui")
    bb.AlwaysOnTop = true; bb.Size = UDim2.new(0, 100, 0, 40); bb.StudsOffset = Vector3.new(0, 3, 0); bb.Adornee = root; bb.Parent = CoreGui
    local lbl = Instance.new("TextLabel", bb)
    lbl.Size = UDim2.new(1,0,1,0); lbl.BackgroundTransparency = 1; lbl.Text = plr.DisplayName; lbl.TextColor3 = Color3.white; lbl.TextStrokeTransparency = 0; lbl.Font = Enum.Font.GothamBold; lbl.TextScaled = true
    playerEspMap[plr] = bb
end

local function setPlayersEsp(enabled)
    playersEspEnabled = enabled
    if enabled then
        for _, plr in ipairs(Players:GetPlayers()) do createPlayerEsp(plr) end
    else
        for _, gui in pairs(playerEspMap) do gui:Destroy() end
        playerEspMap = {}
    end
end

Players.PlayerAdded:Connect(function(plr) if playersEspEnabled then createPlayerEsp(plr) end end)
Players.PlayerRemoving:Connect(function(plr) if playerEspMap[plr] then playerEspMap[plr]:Destroy() end end)

local function updateLockEsp()
    if not lockEspEnabled then
        for _, g in pairs(lockEspMap) do g:Destroy() end; lockEspMap = {}
        return
    end
    -- Simplified Logic Scan
    for _, plot in pairs(workspace.Plots:GetChildren()) do
        -- (Original logic simplified for brevity, assumes structure exists)
        local remainingLabel = plot:FindFirstChild("Purchases", true) and plot.Purchases:FindFirstChild("PlotBlock", true) and plot.Purchases.PlotBlock.Main:FindFirstChild("BillboardGui", true) and plot.Purchases.PlotBlock.Main.BillboardGui:FindFirstChild("RemainingTime", true)
        if remainingLabel then
            local text = remainingLabel.Text == "0s" and "Unlocked" or ("Lock: " .. remainingLabel.Text)
            local color = remainingLabel.Text == "0s" and Color3.new(0,1,0) or Color3.new(1,0,0)
            
            if not lockEspMap[plot.Name] then
                local bb = Instance.new("BillboardGui", plot.Purchases.PlotBlock.Main); bb.Size = UDim2.new(0,100,0,40); bb.AlwaysOnTop = true; bb.StudsOffset = Vector3.new(0,5,0)
                local l = Instance.new("TextLabel", bb); l.Size = UDim2.new(1,0,1,0); l.BackgroundTransparency=1; l.TextScaled=true; l.Font=Enum.Font.GothamBold
                lockEspMap[plot.Name] = bb
            end
            lockEspMap[plot.Name].TextLabel.Text = text
            lockEspMap[plot.Name].TextLabel.TextColor3 = color
        end
    end
end

-- Anti Ragdoll
local function watchCharacter(char)
    local function watchInstance(inst)
        if inst:IsA("BasePart") then
            table.insert(antiConnections, inst.ChildAdded:Connect(function(c)
                if antiRagdollEnabled and (c:IsA("BallSocketConstraint") or c:IsA("HingeConstraint")) then
                    c:Destroy()
                end
            end))
        elseif inst:IsA("Humanoid") then
            table.insert(antiConnections, inst.StateChanged:Connect(function()
                if antiRagdollEnabled and (inst:GetState() == Enum.HumanoidStateType.Physics or inst:GetState() == Enum.HumanoidStateType.Ragdoll) then
                    inst:ChangeState(Enum.HumanoidStateType.GettingUp)
                end
            end))
        end
    end
    for _, c in pairs(char:GetChildren()) do watchInstance(c) end
    table.insert(antiConnections, char.ChildAdded:Connect(watchInstance))
end

-- Desync Logic (Visual)
local function openDesyncGUI()
    -- Original script created a separate GUI. We'll simplify and execute the logic.
    local success = pcall(function()
        local character = LocalPlayer.Character
        local backpack = LocalPlayer:WaitForChild("Backpack")
        local tool = character:FindFirstChildOfClass("Tool")
        if not tool then return end
        
        local packages = ReplicatedStorage:FindFirstChild("Packages")
        local net = packages and packages:FindFirstChild("Net")
        local useItem = net and net:FindFirstChild("RE/UseItem")
        local qClone = net and net:FindFirstChild("RE/QuantumCloner/OnTeleport")
        
        if setfflag then setfflag("WorldStepMax", "-9999999999") end
        task.wait(0.2)
        if useItem then useItem:FireServer() end
        task.wait(1)
        if qClone then qClone:FireServer() end
        task.wait(2)
        if setfflag then setfflag("WorldStepMax", "-1") end
    end)
end

-- Rig Swap (Brainrot Hide)
local function enableRigSwap()
    local character = LocalPlayer.Character
    if not character or not character:FindFirstChild("Humanoid") then return false end
    local hum = character.Humanoid
    originalHipHeight = hum.HipHeight
    realHRP = character:FindFirstChild("HumanoidRootPart")
    if not realHRP then return false end
    
    local temp = Instance.new("Model", game)
    character.Parent = temp
    originalHRP = realHRP:Clone(); originalHRP.Parent = character
    realHRP.Parent = workspace.CurrentCamera; character.PrimaryPart = originalHRP
    character.Parent = workspace
    temp:Destroy()
    
    local anim = Instance.new("Animation"); anim.AnimationId = "http://www.roblox.com/asset/?id=18537363391"
    animTrack = hum:LoadAnimation(anim); animTrack:Play(0,1,0); animTrack.TimePosition = 0.7; animTrack:AdjustSpeed(0)
    
    preSimConn = RunService.PreSimulation:Connect(function()
        if realHRP and character.PrimaryPart then
            realHRP.CFrame = (character.PrimaryPart.CFrame - Vector3.new(0, hum.HipHeight + character.PrimaryPart.Size.Y/2 - 0.91, 0)) * CFrame.Angles(math.rad(180), 0, 0)
            realHRP.Velocity = character.PrimaryPart.Velocity
        end
    end)
    return true
end

local function disableRigSwap()
    if animTrack then animTrack:Stop(); animTrack:Destroy() end
    if preSimConn then preSimConn:Disconnect() end
    if realHRP and LocalPlayer.Character then
        local c = LocalPlayer.Character
        local temp = Instance.new("Model", game); c.Parent = temp
        realHRP.Parent = c; c.PrimaryPart = realHRP; c.Parent = workspace
        if originalHRP then originalHRP:Destroy() end
        c.Humanoid.HipHeight = originalHipHeight
    end
end

-- // BUILDING THE WINDOW //

local Win = UI:CreateWindow("WAVA HUB | Remastered")

-- TAB: Main
local Main = Win:Tab("Main")

Main:Label("Player Movement")
Main:Toggle("Speed Boost", config.SpeedBoost, function(s) updateSpeedBoost(s) end)
Main:Toggle("Infinite Jump", config.InfiniteJump, function(s) 
    infiniteJumpEnabled = s
    config.InfiniteJump = s
    saveConfig() 
end)
UserInputService.JumpRequest:Connect(function()
    if infiniteJumpEnabled and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
        LocalPlayer.Character.Humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
    end
end)

Main:Toggle("Jump Boost", false, function(s) updateJumpBoost(s) end)
Main:Toggle("Float (Hover)", false, function(s) updateFloat(s) end)

Main:Label("Actions")
Main:Button("Teleport UP (+150)", function() 
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        LocalPlayer.Character.HumanoidRootPart.CFrame += Vector3.new(0, 150, 0)
    end
end)
Main:Button("Teleport DOWN (-189)", function() 
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        LocalPlayer.Character.HumanoidRootPart.CFrame -= Vector3.new(0, 189, 0)
    end
end)
Main:Button("God Mode (Heal)", function() 
    godModeEnabled = not godModeEnabled 
end)
RunService.RenderStepped:Connect(function()
    if godModeEnabled and LocalPlayer.Character then
        local h = LocalPlayer.Character:FindFirstChild("Humanoid")
        if h and h.Health < h.MaxHealth then h.Health = h.MaxHealth end
    end
end)

Main:Button("Wava Desync (Tool Req)", function() openDesyncGUI() end)
Main:Toggle("Hide Brainrot (Rig)", false, function(s)
    if s then enableRigSwap() else disableRigSwap() end
end)

-- TAB: Helper
local Helper = Win:Tab("Helper")

Helper:Label("Protection")
Helper:Toggle("Anti Trap", config.AntiTrap, function(s)
    config.AntiTrap = s; saveConfig()
    if s then enableAntiTrap() else disableAntiTrap() end
end)
Helper:Toggle("Anti Ragdoll", false, function(s)
    antiRagdollEnabled = s
    if s and LocalPlayer.Character then watchCharacter(LocalPlayer.Character) end
end)
if LocalPlayer.Character then LocalPlayer.CharacterAdded:Connect(function(c) if antiRagdollEnabled then watchCharacter(c) end end) end

Helper:Label("Automation")
Helper:Toggle("Auto Slap", false, function(s) autoSlapEnabled = s end)
task.spawn(function()
    while true do
        task.wait(0.1)
        if autoSlapEnabled and LocalPlayer.Character then
            local r = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
            if r then
                for _, p in pairs(Players:GetPlayers()) do
                    if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
                        if (r.Position - p.Character.HumanoidRootPart.Position).Magnitude <= 10 then
                            local h = LocalPlayer.Character:FindFirstChild("Humanoid")
                            for _, t in pairs(slapToolNames) do
                                local tool = LocalPlayer.Backpack:FindFirstChild(t) or LocalPlayer.Character:FindFirstChild(t)
                                if tool then
                                    if tool.Parent ~= LocalPlayer.Character then h:EquipTool(tool) end
                                    tool:Activate()
                                end
                            end
                        end
                    end
                end
            end
        end
    end
end)

Helper:Button("Auto Steal (Tween)", function()
    local char = LocalPlayer.Character
    local root = char and char:FindFirstChild("HumanoidRootPart")
    local dh
    for _, p in pairs(workspace.Plots:GetChildren()) do
        local yb = p:FindFirstChild("YourBase", true)
        if yb and yb.Enabled then dh = p:FindFirstChild("DeliveryHitbox", true) break end
    end
    if dh and root then
        local old = root.Position.Y
        root.CFrame += Vector3.new(0, 200, 0)
        task.wait(2)
        local t = TweenService:Create(root, TweenInfo.new((dh.Position - root.Position).Magnitude/30), {CFrame = CFrame.new(dh.Position.X, root.Position.Y, dh.Position.Z)})
        t:Play(); t.Completed:Wait()
        root.CFrame = CFrame.new(root.Position.X, old, root.Position.Z)
    end
end)

-- TAB: ESP
local ESPTab = Win:Tab("ESP")

ESPTab:Label("Visuals")
ESPTab:Toggle("Player ESP", false, function(s) setPlayersEsp(s) end)
ESPTab:Toggle("Lock/Unlock ESP", false, function(s) lockEspEnabled = s; if s then updateLockEsp() end end)
ESPTab:Toggle("Base Timers Overlay", config.ViewBaseTimers, function(s)
    config.ViewBaseTimers = s; saveConfig()
    if s then enablePlotTimers() else disablePlotTimers() end
end)

task.spawn(function()
    while true do
        task.wait(0.5)
        if lockEspEnabled then updateLockEsp() end
    end
end)

-- TAB: Scripts
local Scripts = Win:Tab("Scripts")

Scripts:Label("Loaders")
Scripts:Button("Infinite Yield", function() tryLoadURLToRun("https://raw.githubusercontent.com/wedfwef3/ere.github.io/refs/heads/main/infyield.lua") end)
Scripts:Button("Steal Helper", function() tryLoadURLToRun("https://raw.githubusercontent.com/erewe23/uitest.github.io/refs/heads/main/ere.lua") end)
Scripts:Button("Anti-Steal (OP)", function() tryLoadURLToRun("https://raw.githubusercontent.com/34wefwef/antisteal.github.io/refs/heads/main/ere.lua") end)
Scripts:Button("Most Expensive ESP", function() tryLoadURLToRun("https://raw.githubusercontent.com/34t34t33/mostexpensive.github.io/refs/heads/main/rare.lua") end)

-- TAB: Other
local Other = Win:Tab("Other")

Other:Label("Server & Jobs")
Other:Button("Server Hop", function()
    -- Simple server hop
    local x = {}
    for _, v in ipairs(game:GetService("HttpService"):JSONDecode(game:HttpGetAsync("https://games.roblox.com/v1/games/" .. game.PlaceId .. "/servers/Public?sortOrder=Asc&limit=100")).data) do
        if type(v) == "table" and v.maxPlayers > v.playing and v.id ~= game.JobId then
            x[#x + 1] = v.id
        end
    end
    if #x > 0 then
        TeleportService:TeleportToPlaceInstance(game.PlaceId, x[math.random(1, #x)])
    end
end)

Other:Button("Rejoin", function() TeleportService:TeleportToPlaceInstance(game.PlaceId, game.JobId, LocalPlayer) end)

Other:Label("Job ID Config")
Other:Input("Enter Job ID...", config.SelectedJobId or "", function(t)
    config.SelectedJobId = t
    saveConfig()
end)
Other:Button("Join Job ID", function()
    if config.SelectedJobId then TeleportService:TeleportToPlaceInstance(game.PlaceId, config.SelectedJobId) end
end)

Other:Label("Auto Buy")
Other:Button("Auto Buy Items", function() autoBuySelectedItems() end)

-- TAB: Themes
local Themes = Win:Tab("Themes")
Themes:Label("UI Colors")
Themes:Button("Purple Theme", function() UI:UpdateTheme("Purple") end)
Themes:Button("Red Theme", function() UI:UpdateTheme("Red") end)
Themes:Button("Green Theme", function() UI:UpdateTheme("Green") end)
Themes:Button("Pink Theme", function() UI:UpdateTheme("Pink") end)
Themes:Button("Black (OLED)", function() UI:UpdateTheme("Black") end)
Themes:Button("White (Flashbang)", function() UI:UpdateTheme("White") end)

-- // INIT //

-- Initialize Toggles based on Config
if config.AntiTrap then enableAntiTrap() end
if config.ViewBaseTimers then enablePlotTimers() end
if config.SpeedBoost then updateSpeedBoost(true) end
if config.InfiniteJump then infiniteJumpEnabled = true end

-- Anti-AFK
LocalPlayer.Idled:Connect(function()
    game:GetService("VirtualUser"):CaptureController()
    game:GetService("VirtualUser"):ClickButton2(Vector2.new())
end)

print("Wava Hub Remastered Loaded")
